unit PedidoController;

interface

uses
   System.Generics.Collections,Data.DB,
   PedidoRepository, model.TPedidoDadosGerais, model.TPedidoProdutos;
//  PedidoCompletoDTO

type
  TPedidoController = class
  private
    FRepository: TPedidoRepository;
  public
    constructor Create(ARepository: TPedidoRepository);
    function GravaPedido(Pedido: TPedidoDadosGerais; Itens: TList<TPedidoProdutos>): Boolean;
//    function BuscarPedidoCompleto(NumeroPedido: Integer): TPedidoCompletoDTO;
    function CancelaPedido(nrPedido: Integer): Boolean;
//    function BuscarTodosPedidos: TObjectList<TPedidoCompletoDTO>;
//    function BuscarPedidosPorNomeCliente(const NomeCliente: string): TObjectList<TPedidoCompletoDTO>;
  end;

implementation

{function TPedidoController.BuscarPedidoCompleto(NumeroPedido: Integer): TPedidoCompletoDTO;
begin
  Result := FRepository.BuscarPedidoCompletoPorNumero(NumeroPedido);
end; }

{function TPedidoController.BuscarPedidosPorNomeCliente(const NomeCliente: string): TObjectList<TPedidoCompletoDTO>;
begin
  Result := FRepository.BuscarPedidosPorNomeCliente(NomeCliente);
end; }

{function TPedidoController.BuscarTodosPedidos: TObjectList<TPedidoCompletoDTO>;
begin
 Result := FRepository.BuscarTodosPedidos;
end; }

function TPedidoController.CancelaPedido(nrPedido: Integer): Boolean;
begin
  Result := False;
  try
    if FRepository.CancelarPedido(nrPedido) then
    begin
      FRepository.Commit;
      Result := True;
    end;
  on E: Exception do
    FRepository.Rollback;
    raise Exception.Create('Erro ao cancelar o pedido.'+#13+Format('Erro [%s]: %s', [E.ClassName, E.Message]));
  end;
end;

constructor TPedidoController.Create(ARepository: TPedidoRepository);
begin
  inherited Create;
  FRepository := ARepository;
end;

function TPedidoController.GravaPedido(Pedido: TPedidoDadosGerais; Itens: TList<TPedidoProdutos>): Boolean;
var
numero_pedido: integer;
begin
  Result := False;
  FRepository.StartTransaction;
  try
    numero_pedido := FRepository.InserirPedido(Pedido);

    for var Produto in Produtos do
    begin
      Produto.NumeroPedido := numero_pedido;
      FRepository.InserirItemPedido(Produto);
    end;

    FRepository.Commit;
    Result := True;
  except
    FRepository.Rollback;
    raise;
  end;
end;

end.

